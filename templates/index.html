<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroDiagnostix |  AI Diabetes Risk</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/output.css">
    <script src="https://cdn.plot.ly/plotly-3.3.1.min.js" charset="utf-8"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }

        .glass-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(75, 85, 99, 0.4);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen">
    <nav class="border-b border-gray-800 bg-gray-900/50 backdrop-blur sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="activity" class="text-emerald-500"></i>
                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-cyan-500">
                    NeuroDiagnostix
                </h1>
            </div>
            <div class="text-xs text-gray-500 font-mono">MODEL V.2.1-RC</div>
        </div>
    </nav>
    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-12">
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-panel p-6 rounded-2xl shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i data-lucide="sliders-horizontal" class="w-5 h-5"></i> Vitals Input
                        </h2>
                        <select name="model_choice" id="model_choice" onchange="predict()" class="bg-gray-800 border border-gray-700 text-sm rounded-lg p-2 focus:ring-2 focus:ring-emerald-500 outline-none">
                            <option value="logistic">Logistic Regression</option>
                            <option value="dt">Decision Tree (Optimized)</option>
                        </select>
                    </div>

                    <div class="space-y-5">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-400">Glucose Level</span>
                                <span class="font-mono text-emerald-400" id="val-glucose">120</span>
                            </div>
                            <input type="range" name="glucose" id="glucose" min="0" max="500" value="120"
                                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                                oninput="updateVal('glucose', this.value); predict()"
                            >
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-400">BMI</span>
                                <span class="font-mono text-emerald-400" id="val-bmi">25.0</span>
                            </div>
                            <input type="range" name="bmi" id="bmi" min="0" max="60" step="0.1" value="25"
                                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                                oninput="updateVal('bmi', this.value); predict()"
                            >
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-400">Age</span>
                                <span class="font-mono text-emerald-400" id="val-age">30</span>
                            </div>
                            <input type="range" name="age" id="age" min="1" max="120" value="30"
                                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                                oninput="updateVal('age', this.value); predict()"
                            >
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="pregnancies" class="text-xs text-gray-500 uppercase">Pregnancies</label>
                                <input type="number" name="pregnancies" id="pregnancies" value="0" min="0"
                                    class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-emerald-500 outline-none transition"
                                    oninput="predict()"
                                >
                            </div>
                            <div>
                                <label for="bp" class="text-xs text-gray-500 uppercase">Blood Pressure (mm Hg)</label>
                                <input type="number" name="bp" id="bp" value="70" min="0"
                                    class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-emerald-500 outline-none transition"
                                    oninput="predict()"
                                >
                            </div>
                            <div>
                                <label for="dpf" class="text-xs text-gray-500 uppercase">DPF Score</label>
                                <input type="number" id="dpf" value="0.5" step="0.01" 
                                    class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-emerald-500 outline-none transition"
                                    oninput="predict()"
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <div id="result-card" style="background-color: rgba(31, 41, 55, 0.7); backdrop-filter: blur(10px);" class="p-6 rounded-2xl shadow-xl transition-all duration-300 border-l-4 border-emerald-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm text-gray-400 uppercase tracking-wider">Assessment</p>
                            <h3 id="pred-text" class="text-3xl font-bold text-white mt-1">Healthy</h3>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-400">Confidence</p>
                            <p id="pred-prob" class="text-2xl font-mono text-emerald-400">0%</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div class="glass-panel p-1 rounded-2xl shadow-xl h-full relative group">
                    <div id="plot3d" class="w-full h-150 rounded-xl overflow-hidden"></div>
                    <div id="plot-loader" class="absolute inset-0 bg-gray-900/80 flex items-center justify-center z-10 rounded-xl">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-500"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-panel rounded-2xl p-8 shadow-xl">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div>
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i data-lucide="database" class="text-blue-500"></i> Batch Analysis
                    </h2>
                    <p class="text-gray-400 text-sm mt-1">Upload a CSV to process multiple patients at once.</p>
                </div>
                <form id="upload-form" class="flex gap-3">
                    <input type="file" name="csv_file" id="csv_file" accept=".csv" class="text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-800 file:text-emerald-400 hover:file:bg-gray-700 cursor-pointer">
                    <button type="button" onclick="uploadBatch()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <i data-lucide="upload-cloud" class="w-4 h-4"></i> Analyze Batch
                    </button>
                    <div id="download-zone" class="hidden">
                        <button onclick="downloadCurrentBatch()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i> Download Results
                        </button>
                    </div>
                </form>
            </div>
            <div class="overflow-x-auto rounded-lg border border-gray-700">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs text-gray-300 uppercase bg-gray-800">
                        <tr>
                            <th class="px-6 py-3">Patient ID</th>
                            <th class="px-6 py-3">Pregnancies</th>
                            <th class="px-6 py-3">Glucose</th>
                            <th class="px-6 py-3">BMI</th>
                            <th class="px-6 py-3">Age</th>
                            <th class="px-6 py-3 text-right">Probability %</th>
                            <th class="px-6 py-3 text-right">Result</th>
                        </tr>
                    </thead>
                    <tbody id="batch-results-body">
                        <tr>
                            <td colspan="7" class="px-6 py-8 text-center text-gray-500 italic">
                                No data uploaded yet.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    <footer class="text-center py-6 text-gray-600 text-sm">
        <p>Powered by Scikit-Learn, FastAPI & Plotly</p>
    </footer>

    <script>
        lucide.createIcons();
        
        let backgroundData = [];
        let isBatchView = false;

        window.onload = async function() {
            try {
                const response = await fetch('/api/background-data');
                backgroundData = await response.json();
                
                if(!backgroundData.length) {
                    backgroundData = [{Glucose: 100, BMI: 20, Age: 30, Outcome: 0}];
                }

                initSinglePlot();
                document.getElementById('plot-loader').style.display = 'none';
                predict(); 
            } catch (err) {
                console.error(err);
            }
        };

        function updateVal(id, val) {
            document.getElementById('val-' + id).innerText = val;
        }

        function initSinglePlot() {
            const healthy = backgroundData.filter(d => d.Outcome === 0);
            const diabetic = backgroundData.filter(d => d.Outcome === 1);
            const hTemplate = "Glucose: %{x}<br>BMI: %{y}<br>Age: %{z}<extra></extra>";

            const traceHealthy = {
                x: healthy.map(d => d.Glucose), y: healthy.map(d => d.BMI), z: healthy.map(d => d.Age),
                mode: 'markers', type: 'scatter3d', name: 'Historical Healthy',
                marker: { size: 4, color: '#34d399', opacity: 0.4 },
                hovertemplate: hTemplate
            };

            const traceDiabetic = {
                x: diabetic.map(d => d.Glucose), y: diabetic.map(d => d.BMI), z: diabetic.map(d => d.Age),
                mode: 'markers', type: 'scatter3d', name: 'Historical Diabetic',
                marker: { size: 4, color: '#f87171', opacity: 0.4 },
                hovertemplate: hTemplate
            };

            const traceUser = {
                x: [0], y: [0], z: [0],
                mode: 'markers', type: 'scatter3d', name: 'Current Patient',
                marker: { size: 6, color: '#fbbf24', symbol: 'diamond', line: { color: 'white', width: 2 } },
                hovertemplate: hTemplate
            };

            const layout = getCommonLayout();
            
            Plotly.newPlot('plot3d', [traceHealthy, traceDiabetic, traceUser], layout);
            isBatchView = false;
        }

        function visualizeBatch(batchData) {
            const batchHealthy = batchData.filter(d => d.Prediction === "Healthy");
            const batchDiabetic = batchData.filter(d => d.Prediction === "Diabetic");
            const hTemplate = "Glucose: %{x}<br>BMI: %{y}<br>Age: %{z}<extra></extra>";

            const traceBatchHealthy = {
                x: batchHealthy.map(d => d.Glucose), y: batchHealthy.map(d => d.BMI), z: batchHealthy.map(d => d.Age),
                mode: 'markers', type: 'scatter3d', name: 'Batch: Healthy',
                marker: { size: 5, color: '#66ff66', opacity: 0.6 },
                hovertemplate: hTemplate
            };

            const traceBatchDiabetic = {
                x: batchDiabetic.map(d => d.Glucose), y: batchDiabetic.map(d => d.BMI), z: batchDiabetic.map(d => d.Age),
                mode: 'markers', type: 'scatter3d', name: 'Batch: Diabetic',
                marker: { size: 5, color: '#ff6666', opacity: 0.6 },
                hovertemplate: hTemplate
            };

            const bgHealthy = backgroundData.filter(d => d.Outcome === 0);
            const bgDiabetic = backgroundData.filter(d => d.Outcome === 1);
            const traceBgHealthy = {
                x: bgHealthy.map(d => d.Glucose), y: bgHealthy.map(d => d.BMI), z: bgHealthy.map(d => d.Age),
                mode: 'markers', type: 'scatter3d', name: 'Historic Healthy', marker: { size: 4, color: '#34d399', opacity: 0.4 },
                hovertemplate: hTemplate
            };
            const traceBgDiabetic = {
                x: bgDiabetic.map(d => d.Glucose), y: bgDiabetic.map(d => d.BMI), z: bgDiabetic.map(d => d.Age),
                mode: 'markers', type: 'scatter3d', name: 'History Diabetic', marker: { size: 4, color: '#f87171', opacity: 0.4 },
                hovertemplate: hTemplate
            };

            Plotly.newPlot('plot3d', [traceBgHealthy, traceBgDiabetic, traceBatchHealthy, traceBatchDiabetic], getCommonLayout());
            isBatchView = true;
        }

        function getCommonLayout() {
            return {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                scene: {
                    xaxis: { title: { text: 'Glucose' }, color: 'white' },
                    yaxis: { title: { text: 'BMI' }, color: 'white' },
                    zaxis: { title: { text: 'Age' }, color: 'white' },
                },
                hovermode: "closest",
                margin: { l: 0, r: 0, b: 0, t: 0 },
                legend: { font: { color: 'white' } }
            };
        }

        async function predict() {
            if (isBatchView) {
                initSinglePlot();
            }

            const inputs = {
                pregnancies: parseInt(document.getElementById('pregnancies').value) || 0,
                glucose: parseFloat(document.getElementById('glucose').value),
                bp: parseFloat(document.getElementById('bp').value),
                bmi: parseFloat(document.getElementById('bmi').value),
                dpf: parseFloat(document.getElementById('dpf').value),
                age: parseInt(document.getElementById('age').value),
                model_choice: document.getElementById('model_choice').value
            };

            try {
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });
                
                const result = await response.json();
                
                const card = document.getElementById('result-card');
                const text = document.getElementById('pred-text');
                const prob = document.getElementById('pred-prob');
                
                text.innerText = result.prediction === 1 ? "High Risk (Diabetic)" : "Low Risk (Healthy)";
                prob.innerText = result.probability + "%";
                
                if (result.prediction === 1) {
                    card.classList.add('border-l-2');
                    card.classList.remove('border-emerald-500');
                    card.classList.add('border-red-500', 'bg-red-900/20');
                    text.classList.replace('text-emerald-400', 'text-red-400');
                    prob.classList.replace('text-emerald-400', 'text-red-400');
                } else {
                    card.classList.remove('border-red-500', 'bg-red-900/20'); card.classList.add('border-emerald-500');
                    text.classList.replace('text-red-400', 'text-emerald-400');
                    prob.classList.replace('text-red-400', 'text-emerald-400');
                }

                Plotly.restyle('plot3d', {
                    x: [[inputs.glucose]], y: [[inputs.bmi]], z: [[inputs.age]]
                }, [2]);

            } catch (err) {
                console.error(err);
            }
        }

        function downloadCSV(data) {
            if (!data || !data.length) return;
            
            const headers = Object.keys(data[0]).join(",");
            const rows = data.map(row => Object.values(row).join(","));
            const csvContent = "data:text/csv;charset=utf-8," + headers + "\n" + rows.join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "processed_diabetes_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadCurrentBatch() {
            downloadCSV(window.currentBatchData);
        }

        async function uploadBatch() {
            const fileInput = document.getElementById('csv_file');
            if (!fileInput.files[0]) { alert("Please select a CSV file first."); return; }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('model_choice', document.getElementById('model_choice').value);

            const btn = event.currentTarget;
            btn.innerHTML = `<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div> Processing...`;

            try {
                const response = await fetch('/api/batch-predict', { method: 'POST', body: formData });
                const data = await response.json();
                
                const tbody = document.getElementById('batch-results-body');
                tbody.innerHTML = '';
                data.results.forEach((row, index) => {
                    const isHighRisk = row.Prediction === "Diabetic";
                    const tr = `
                        <tr class="border-b border-gray-800 hover:bg-gray-800/50 transition">
                            <td class="px-6 py-4 font-mono text-xs">ID_${index + 1000}</td>
                            <td class="px-6 py-4">${row.Pregnancies || '-'}</td>
                            <td class="px-6 py-4">${row.Glucose}</td>
                            <td class="px-6 py-4">${row.BMI}</td>
                            <td class="px-6 py-4">${row.Age}</td>
                            <td class="px-6 py-4 text-right font-mono">${row["Probability %"]}%</td>
                            <td class="px-6 py-4 text-right ${isHighRisk ? "text-red-400 font-bold" : "text-emerald-400"}">${row.Prediction}</td>
                        </tr>`;
                    tbody.innerHTML += tr;
                });

                visualizeBatch(data.results);
                document.getElementById('download-zone').classList.remove('hidden');
                window.currentBatchData = data.results;
            } catch (err) {
                alert("Error processing batch.");
            } finally {
                btn.innerHTML = `<i data-lucide="upload-cloud" class="w-4 h-4 mr-2"></i> Analyze Batch`;
                lucide.createIcons();
            }
        }
    </script>
</body>
</html>